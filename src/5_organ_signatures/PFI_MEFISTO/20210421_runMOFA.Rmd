---
title: "MEFISTO on pan-fetal immune"
output: html_notebook
---
```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(MOFA2)
  library(Matrix)
  library(SingleCellExperiment)
  library(scran)}
  )
```

## Load pseudobulked data

```{r}
indir <- "/nfs/team205/ed6/data/Fetal_immune/LMM_data/LMM_input_MYELOID_PBULK/"

matrix <- readMM(file = paste0(indir, "matrix.mtx.gz"))
coldata <- read.csv(file = paste0(indir, "metadata.csv.gz")) %>%
  column_to_rownames("X")
rowdata <- read.csv(file = paste0(indir, "gene.csv.gz")) 

## Make SingleCellExperiment obj
myeloid_sce <- SingleCellExperiment(list(logcounts = t(matrix)), colData = coldata)
rownames(myeloid_sce) <- make.unique(rowdata$GeneName) 
```


## Preprocessing

Exclude celltypes present in just one organ
```{r}
keep_ct <- data.frame(colData(myeloid_sce)) %>%
  select(organ, anno_lvl_2) %>%
  distinct() %>%
  group_by(anno_lvl_2) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  filter(n > 1) %>%
  pull(anno_lvl_2)

myeloid_sce <- myeloid_sce[,myeloid_sce$anno_lvl_2 %in% keep_ct]
myeloid_sce
```

Feature selection: options here

- select HVGS with scran
- use same HVGS used for clustering
(these options don't maximize variation between organs)
- **Find HVGS within each celltype and take union**

```{r}
# all_obs <- read_csv("/nfs/team205/ed6/data/Fetal_immune/PAN.A01.v01.entire_data_normalised_log.wGut.batchCorrected_20210118.")

## Feature selection w scran WITHIN CELLTYPE
anno_groups <- split(colnames(myeloid_sce), myeloid_sce$anno_lvl_2)
all_hvgs <- c()
for (i in anno_groups){
  dec <- modelGeneVar(myeloid_sce[,i])
  hvgs <- getTopHVGs(dec, n = 1000)
  all_hvgs <- union(all_hvgs, hvgs)
  }

myeloid_sce <- myeloid_sce[all_hvgs,]
myeloid_sce <- myeloid_sce[which(rowSums(logcounts(myeloid_sce)) > 0),]
myeloid_sce
```

Scale
```{r}
assay(myeloid_sce, "scaled_logcounts") <- t(scale(t(logcounts(myeloid_sce))))
```

EDA with PCA
```{r, fig.height=15, fig.width=15}
library(scater)
myeloid_sce <- runPCA(myeloid_sce, scale=FALSE, ncomponents=30)

## Variance explained
percent.var <- attr(reducedDim(myeloid_sce), "percentVar")
plot(percent.var, log="y", xlab="PC", ylab="Variance explained (%)")

plotPCA(myeloid_sce, colour_by="organ", ncomponents=6)
plotPCA(myeloid_sce, colour_by="anno_lvl_2", ncomponents=6)
```
```{r}
plotPCA(myeloid_sce, colour_by="anno_lvl_2", text_by="anno_lvl_2")
plotPCA(myeloid_sce, colour_by="organ", text_by="anno_lvl_2")
```

Minimize obvious technical effects (3GEX/5GEX) using linear regression (following procedure from [OSCA](https://bioconductor.org/books/release/OSCA/integrating-datasets.html#linear-regression))

```{r}
library(batchelor)
myeloid_sce_3gex <- myeloid_sce[,myeloid_sce$method=="3GEX"]
myeloid_sce_5gex <- myeloid_sce[,myeloid_sce$method=="5GEX"]

set.seed(10001)
residuals <- regressBatches(myeloid_sce_3gex, myeloid_sce_5gex, d=30,
    assay.type = "logcounts",
    correct.all=TRUE,
    BSPARAM=BiocSingular::RandomParam())

assay(myeloid_sce, "scaled_logcounts") <- as.matrix(assay(residuals[,colnames(myeloid_sce)], "corrected"))

```

# Model 1 - Normal MOFA / organs as views

Make MOFA object. Use
- Organ as view
- Celltypes as groups

```{r}
## Split into one matrix x organ
org_ixs <- split(colnames(myeloid_sce), myeloid_sce$organ)
data <- lapply(org_ixs, function(i) assay(myeloid_sce[,i], "scaled_logcounts"))
data <- lapply(data, as.matrix)

## Collapse measurements from the same donor/library prep
new_sample <- paste(myeloid_sce$donor, myeloid_sce$method,myeloid_sce$anno_lvl_2, sep="-")
newsample_ixs <- split(new_sample, myeloid_sce$organ)
for (o in names(data)){
  colnames(data[[o]]) <- newsample_ixs[[o]]
}

## Fill missing values
sample_names_unique <- unique(new_sample)
for (o in names(data)){
  for (s in sample_names_unique){
    if (!s %in% colnames(data[[o]])) {
      m <- matrix(NA, nrow=nrow(data[[o]]))
      colnames(m) <- s
      data[[o]] <- cbind(data[[o]], m)
    }
  }
  data[[o]] <- data[[o]][,sample_names_unique]
}

## Vector for group assignment
groups <- sapply(strsplit(sample_names_unique, "-"), function(x) x[3])

myeloid_mofa <- create_mofa_from_matrix(data, groups = groups)
myeloid_mofa
```

## Regular MOFA
```{r}
myeloid_mofa
```

Prepare 4 training

```{r}
data_opts <- get_default_data_options(myeloid_mofa)
data_opts$center_groups <- FALSE

model_opts <- get_default_model_options(myeloid_mofa)
model_opts$num_factors <- 20

train_opts <- get_default_training_options(myeloid_mofa)
train_opts$seed <- 2020
train_opts$convergence_mode <- "fast" # use "fast" for faster training
train_opts$stochastic <- FALSE

mefisto_opts <- get_default_mefisto_options(myeloid_mofa)
mefisto_opts$warping <- FALSE
# mefisto_opts$sparseGP <- TRUE

myeloid_mofa <- prepare_mofa(
  object = myeloid_mofa,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts,
  mefisto_options = mefisto_opts
) 
```

## Train

```{r}
outfile <- "/nfs/team205/ed6/data/Fetal_immune/myeloid_mofa_model.hdf5"
myeloid_mofa_trained <- run_mofa(myeloid_mofa, outfile = outfile)
```

## Load trained model
```{r}
myeloid_mofa_trained <- load_model(outfile)
```
```{r, fig.width=15, fig.height=5}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 1:10)
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 11:20)
```


Plot weights correlation across organs (are the same genes related to a factor)

```{r}
for (f in colnames(myeloid_mofa_trained@expectations$W$BM)){
  cormat <- cor(sapply(get_weights(myeloid_mofa_trained,  factors = f, as.data.frame = FALSE), function(v) v[,1])) 
  pheatmap::pheatmap(cormat, main=f, cluster_rows = FALSE, cluster_cols = FALSE)
}
```

Add some covariates

```{r}
samples_metadata(myeloid_mofa_trained)  <- samples_metadata(myeloid_mofa_trained) %>%
  mutate(method=sapply(str_split(sample,"-"), function(x) x[2]),
         donor=sapply(str_split(sample,"-"), function(x) x[1]))

## Vector for time assignment
times <- distinct(data.frame(age=myeloid_sce$age, new_sample)) %>%
  column_to_rownames('new_sample') %>%
  .[sample_names_unique,]

samples_metadata(myeloid_mofa_trained)[["time"]] <- times
```

### Factor 1
```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 1)
```


```{r, fig.width=15, fig.height=8}
library(RColorBrewer)

get_view_genes <- function(myeloid_mofa_trained, view, factor, nfeatures=50){
  genes <- get_weights(myeloid_mofa_trained, views=view, factors = factor, as.data.frame = TRUE) %>%
  mutate(feature=str_remove(feature, "_.+")) %>%
  mutate(rank=rank(abs(value))) %>%
  top_n(nfeatures, rank) %>%
  pull(feature)
  return(genes)
}

plot_view_genes <- function(gs, filter_anno=NULL){
  if (is.null(filter_anno)) {
    pl_mat <- assay(myeloid_sce[gs,], "scaled_logcounts")
  } else {
    pl_mat <- assay(myeloid_sce[gs,myeloid_sce$anno_lvl_2 %in% filter_anno], "scaled_logcounts")
  }
  pl_anno <- data.frame(organ=myeloid_sce$organ, annotation=myeloid_sce$anno_lvl_2)
  rownames(pl_anno) <- colnames(myeloid_sce)
  
  print(pheatmap::pheatmap(pl_mat, annotation_col=pl_anno, show_colnames = FALSE, 
                     annotation_colors = list(organ=setNames(brewer.pal(9, "Spectral"), unique(pl_anno$organ)))))
}

gs <- get_view_genes(myeloid_mofa_trained, view="BM", factor=1)
plot_view_genes(gs)
```

### Factor 4

```{r, fig.width=15, fig.height=8}
gs <- get_view_genes(myeloid_mofa_trained, view="TH", factor=4)
plot_view_genes(gs)
plot_view_genes(gs, filter_anno = c("DC1", "DC_progen", "DC2"))
```

## Factor 6

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 6)
```

```{r}
plot_factor(myeloid_mofa_trained, factors = 6, color_by = "method")
```
```{r}
plot_data_heatmap(myeloid_mofa_trained, view="BM", factor = 6)
```


```{r, fig.width=15, fig.height=8}
gs <- get_view_genes(myeloid_mofa_trained, view="BM", factor=6)
plot_view_genes(gs)
plot_view_genes(gs, filter_anno = c("DC3"))
```

## Factor 7

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 7)
```

```{r, fig.height=10, fig.width=15}
plot_data_heatmap(myeloid_mofa_trained, view="TH", factor = 7, annotation_samples = "group")
gs <- get_view_genes(myeloid_mofa_trained, view="TH", factor=7)
plot_view_genes(gs)
```


## Factor 8

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 8)
```

```{r, fig.height=10, fig.width=18}
plot_data_heatmap(myeloid_mofa_trained, view="BM", factor = 8, annotation_samples = "group")
plot_data_heatmap(myeloid_mofa_trained, view="LI", factor = 8, annotation_samples = "group")
plot_data_heatmap(myeloid_mofa_trained, view="SK", factor = 8, annotation_samples = "group")
gs <- get_view_genes(myeloid_mofa_trained, view="BM", factor = 8)
plot_view_genes(gs)
```
```{r}
# sapply(get_weights(myeloid_mofa_trained,  factors = 8, as.data.frame = FALSE), function(v) v[,1]) 
```

## Factor 9

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 9)
```
```{r, fig.width=10, fig.height=3}
plot_factor(myeloid_mofa_trained, factors = 9, group_by =  "time", color_by = "group",  add_boxplot = TRUE, dodge = TRUE)
```
```{r, fig.height=10, fig.width=18}
plot_data_heatmap(myeloid_mofa_trained, view="BM", factor = 9, annotation_samples = "group")
plot_data_heatmap(myeloid_mofa_trained, view="SP", factor = 9, annotation_samples = "group")
plot_data_heatmap(myeloid_mofa_trained, view="SK", factor = 9, annotation_samples = "group")
gs <- get_view_genes(myeloid_mofa_trained, view="BM", factor = 9)
plot_view_genes(gs, filter_anno = c("promonocyte", "Promyelocyte", "DC3", "GMP"))
```

## Factor 11

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 11)
```
```{r, fig.width=10, fig.height=3}
plot_factor(myeloid_mofa_trained, factors = 11, group_by =  "time", color_by = "group")
```
## Factor 12

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 12)
```
```{r, fig.width=10, fig.height=3}
plot_factor(myeloid_mofa_trained, factors = 12, color_by = "group")
```
```{r, fig.height=10, fig.width=18}
plot_data_heatmap(myeloid_mofa_trained, view="SK", factor = 12, annotation_samples = "group")
gs <- get_view_genes(myeloid_mofa_trained, view="SK", factor = 12)
plot_view_genes(gs)
```
```{r}
plot_top_weights(myeloid_mofa_trained, view="SK", factor = 12)
plot_data_scatter(myeloid_mofa_trained, 
  view = "SK", 
  factor = 12, 
  features = 10,         # Number of features to show
  sign = "positive",     # select top 6 features with positive weights
  color_by = "group",  # color cells by lineage
  add_lm = T,          # add linear regression estimates
  lm_per_group = F, 
  dot_size = 2
)
```

## Factor 13

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 13)
```

```{r, fig.width=10, fig.height=3}
plot_factor(myeloid_mofa_trained, factors = 13, color_by = "group")
```

## Factor 14

```{r}
plot_variance_explained(myeloid_mofa_trained, y = "group", factors = 14)
```

```{r, fig.width=10, fig.height=3}
plot_factor(myeloid_mofa_trained, factors = 14, color_by = "group")
```

```{r, fig.height=10, fig.width=18}
plot_data_heatmap(myeloid_mofa_trained, view="YS", factor = 14, annotation_samples = "group")
gs <- get_view_genes(myeloid_mofa_trained, view="YS", factor = 14)
plot_view_genes(gs)
```

## Make signatures from latent factors

```{r}
get_weights()
```

# Model 2 - Normal MOFA / only celltypes as groups

Make MOFA object. Use
- Celltypes as groups

```{r}
myeloid_mofa <- create_mofa_from_SingleCellExperiment(myeloid_sce, assay = "scaled_logcounts", groups = "anno_lvl_2")
myeloid_mofa
```

Prepare 4 training

```{r}
data_opts <- get_default_data_options(myeloid_mofa)
data_opts$center_groups <- FALSE

model_opts <- get_default_model_options(myeloid_mofa)
model_opts$num_factors <- 20

train_opts <- get_default_training_options(myeloid_mofa)
train_opts$seed <- 2020
train_opts$convergence_mode <- "medium" # use "fast" for faster training
train_opts$stochastic <- FALSE

mefisto_opts <- get_default_mefisto_options(myeloid_mofa)
mefisto_opts$warping <- FALSE
# mefisto_opts$sparseGP <- TRUE

myeloid_mofa <- prepare_mofa(
  object = myeloid_mofa,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts,
  mefisto_options = mefisto_opts
) 
```

## Train

```{r}
outfile <- "/nfs/team205/ed6/data/Fetal_immune/myeloid_mofa_model_oneview.hdf5"
myeloid_mofa_trained <- run_mofa(myeloid_mofa, outfile = outfile)
```

```{r}
myeloid_mofa_trained <- load_model(outfile)
```
Add some covariates

```{r}

samples_metadata(myeloid_mofa_trained)  <- samples_metadata(myeloid_mofa_trained) %>%
  mutate(time=myeloid_sce[,match(samples_metadata(myeloid_mofa_trained)$sample, colnames(myeloid_sce))]$age,
         method=myeloid_sce[,match(samples_metadata(myeloid_mofa_trained)$sample, colnames(myeloid_sce))]$method,
         donor=myeloid_sce[,match(samples_metadata(myeloid_mofa_trained)$sample, colnames(myeloid_sce))]$donor,
         organ=myeloid_sce[,match(samples_metadata(myeloid_mofa_trained)$sample, colnames(myeloid_sce))]$organ)
```

```{r}
plot_variance_explained(myeloid_mofa_trained, x='factor', y='group', split_by = 'view', plot_total = TRUE)[[1]] +
  theme(axis.text.x = element_text(angle=45, hjust=1))

get_variance_explained(myeloid_mofa_trained, as.data.frame = TRUE)[[2]] %>%
  ggplot(aes(group, value)) +
  geom_col() +
  coord_flip() +
  ylab("Var. (%)") +
  theme_classic(base_size=14)
```

Plot by celltype
```{r, fig.width=10, fig.height=10}
get_variance_explained(myeloid_mofa_trained, as.data.frame = TRUE)[[1]] %>%
  ggplot(aes(factor, value)) + geom_col() +
  coord_flip() +
  facet_wrap(group~., ncol = 6, scales = "free_x")
```
```{r}
get_variance_explained(myeloid_mofa_trained, as.data.frame = TRUE, views = "scaled_logcounts")[[1]] %>%
  pivot_wider(id_cols=c(group), names_from=factor, values_from=value) %>%
  column_to_rownames("group") %>%
  as.matrix() %>%
  t() %>%
  cor() %>%
  pheatmap::pheatmap()
```


```{r, fig.width=15, fig.height=4}
for (f in colnames(myeloid_mofa_trained@expectations$W$scaled_logcounts)){
  print(plot_factor(myeloid_mofa_trained, factors = f, group_by = "group", color_by = "organ", dot_size = 0.8, add_boxplot = TRUE, dodge = TRUE))
}
```

Insights so far:

1. Factor1:
2. Factor2:
3. Factor3: MAST/Baso/Eo vs rest
4. Factor4: DC1 signature, TH specific
5. Factor5: MAST/Baso/Eo, low in BM
6. Factor6: progenitors signal, correlated with age (progenitor maturation?)
7. Factor7: differences within ERY_MAC, more expression of hemoglobin genes in liver and bone marrow than SK
8/9. Factors 8 and 9 look technical (heatshock proteins)
10. CLP vs GMP signature (BM vs SP and LI)
14. Factor 14: GU specific DC and Mono signature


```{r}
plot_factor_ordered <- function(myeloid_mofa_trained, f){
  get_factors(myeloid_mofa_trained, factors = f, as.data.frame = TRUE) %>%
    mutate(organ = sapply(str_split(sample, "-"), function(x) x[length(x)-3])) %>%
    group_by(group) %>%
    mutate(gr_mean = median(value)) %>%
    ungroup() %>%
    arrange(gr_mean) %>%
    mutate(group=factor(group, levels=unique(group))) %>%
    ggplot(aes(group, value, color=group)) +
    geom_boxplot() +
    geom_jitter() +
    geom_hline(yintercept = 0, linetype=2) +
    coord_flip()
}

plot_factor_ordered(myeloid_mofa_trained, f=1)
plot_factor_ordered(myeloid_mofa_trained, f=2)
plot_factor_ordered(myeloid_mofa_trained, f=3)
plot_factor_ordered(myeloid_mofa_trained, f=7)
plot_factor_ordered(myeloid_mofa_trained, f=10)
plot_factor_ordered(myeloid_mofa_trained, f=14)
```
```{r, fig.width=15, fig.height=5}
plot_factor(myeloid_mofa_trained, factors = 10, color_by = "organ", group_by = "group", dodge = TRUE, dot_size = 2, add_boxplot = TRUE)
plot_weights(myeloid_mofa_trained, factors = 4, nfeatures = 50, text_size = 6)
plot_weights_scatter(myeloid_mofa_trained, factors = 9:10)
```


<!-- ```{r, fig.width=15, fig.height=5} -->
<!-- get_factors(myeloid_mofa_trained, factors = 3, as.data.frame = TRUE) %>% -->
<!--   mutate(organ = sapply(str_split(sample, "-"), function(x) x[length(x)-3])) %>% -->
<!--   group_by(group) %>% -->
<!--   mutate(gr_mean = median(value)) %>% -->
<!--   ungroup() %>% -->
<!--   arrange(gr_mean) %>% -->
<!--   mutate(group=factor(group, levels=unique(group))) %>% -->
<!--   ggplot(aes(organ, value, color=organ)) + -->
<!--   geom_boxplot() + -->
<!--   geom_jitter() + -->
<!--   # geom_hline(yintercept = 0, linetype=2) + -->
<!--   coord_flip() + -->
<!--   facet_wrap(.~group, scales = "free_x") -->
<!--             group_by = "group",  dot_size = 0.8, add_boxplot = TRUE, dodge = TRUE) + -->
<!--   coord_flip() -->
<!-- ``` -->


## Go by celltype instead of factor

### DC1
```{r}
get_variance_explained(myeloid_mofa_trained, as.data.frame = TRUE)[[1]] %>%
  filter(group=="DC1") %>%
  ggplot(aes(factor, value)) + geom_col() +
  coord_flip() +
  facet_wrap(group~., ncol = 6, scales = "free_x")
```
```{r}
plot_factors(myeloid_mofa_trained, factors = c(2,4), color_by = "organ", groups = "DC1")
```

```{r, fig.width=12, fig.height=4}
plot_factor(myeloid_mofa_trained, factors = c(4), color_by = "organ", group_by = "organ", groups = "DC1")
plot_factor(myeloid_mofa_trained, factors = 4, group_by = "group", color_by = "organ", dot_size = 0.8, add_boxplot = TRUE, dodge = TRUE)
```
```{r}
plot_weights(myeloid_mofa_trained, factors = 4, nfeatures = 30)
```
```{r}
plot_data_scatter(myeloid_mofa_trained, factor = 4, groups="DC1", color="organ", features="HLA-DRA")
```

## Explore by factor
```{r}
plot_factor(myeloid_mofa_trained, factor = 3)
plot_weights(myeloid_mofa_trained, factor = 3, nfeatures = 20)
```


## Find factors that discriminate between organs


```{r}
get_organ_AUC <- function(myeloid_mofa_trained, f, gr){
  f_df <- get_factors(myeloid_mofa_trained, factors = f, groups = gr, as.data.frame = TRUE) %>%
    # group_by(group) %>%
    # mutate(value=scale(value)) %>%
    # ungroup() %>%
    mutate(organ = sapply(str_split(sample, "-"), function(x) x[length(x)-3])) 
  organs <- unique(f_df$organ)
  suppressWarnings(suppressMessages({org_auc <- sapply(organs, function(org) roc(as.numeric(f_df$organ==org), f_df$value)$auc)}))
  all_organs <- as.character(unique(myeloid_mofa_trained@samples_metadata$organ))
  org_auc <- setNames(org_auc[all_organs], all_organs)
  return(org_auc)
}

all_organs <- as.character(unique(myeloid_mofa_trained@samples_metadata$organ))
all_groups <- as.character(unique(myeloid_mofa_trained@samples_metadata$group))

## Mask if too little samples
n_samples_mat <- samples_metadata(myeloid_mofa_trained) %>%
  group_by(organ, group) %>%
  summarise(n_samples=n()) %>%
  pivot_wider(id_cols=c(group), names_from="organ", values_from="n_samples", values_fill=0) %>%
  column_to_rownames("group") %>%
  as.matrix()

mask_pairs <- t(n_samples_mat < 3)

AUC_mat <- sapply(all_groups, function(g) get_organ_AUC(myeloid_mofa_trained, f=10, gr=g))
AUC_mat[mask_pairs[rownames(AUC_mat), colnames(AUC_mat)]] <- NA

AUC_thresh = 0.8
reshape2::melt(AUC_mat, varnames=c("organ", "group"), value.name="AUC") %>%
  ggplot(aes(organ, group)) +
  geom_point(aes(size=AUC, color=AUC)) +
  geom_point(data=. %>% filter(AUC > AUC_thresh), shape=8, size=2,color="white") +
  scale_size(limits = c(0.5,1)) +
  scale_color_gradientn(colours = RColorBrewer::brewer.pal(5, "Reds"))
```


```{r, fig.width=15, fig.height=4}
library(patchwork)
plot_factor(myeloid_mofa_trained, factors = 5, group_by = "group", color_by = "organ", dodge = TRUE, add_boxplot = TRUE) 

  plot_layout(guides="collect")

```
```{r}
plot_weights(myeloid_mofa_trained, factors = 5, nfeatures = 30)
```
```{r}
plot_data_heatmap(myeloid_mofa_trained, factor = 5, show_colnames=FALSE)
```



# Model 3 -  MEFISTO 

Add time as covariate to run MEFISTO

```{r}
## Vector for time assignment
times <- distinct(data.frame(age=myeloid_sce$age, new_sample)) %>%
  column_to_rownames('new_sample') %>%
  .[sample_names_unique,]

samples_metadata(myeloid_mofa)[["time"]] <- times

myeloid_mofa <- set_covariates(myeloid_mofa, covariates = "time")
myeloid_mofa
```
```{r, fig.height=15, fig.width=10}
gg_input <- plot_data_overview(myeloid_mofa,
                               show_covariate = TRUE,
                               show_dimensions = TRUE) 
gg_input
```

<!-- Keep groups that span multiple views -->
<!-- ```{r} -->
<!-- gr_samples <- split(samples_metadata(myeloid_mofa)$sample, samples_metadata(myeloid_mofa)$group) -->
<!-- all(is.na(data$BM[,gr_samples$Basophil])) -->
<!-- lapply(unique(samples_metadata(myeloid_mofa)[["group"]]), function(x) data$BM[]) -->


<!-- myeloid_mofa@data -->
<!-- subse(myeloid_mofa)[,samples_metadata(myeloid_mofa)[["group"]] == "Basophil"] -->
<!-- ``` -->

Prepare 4 training

```{r}
data_opts <- get_default_data_options(myeloid_mofa)

model_opts <- get_default_model_options(myeloid_mofa)
model_opts$num_factors <- 10

train_opts <- get_default_training_options(myeloid_mofa)
train_opts$seed <- 2020
train_opts$convergence_mode <- "fast" # use "fast" for faster training

mefisto_opts <- get_default_mefisto_options(myeloid_mofa)
mefisto_opts$warping <- FALSE
# mefisto_opts$sparseGP <- TRUE

myeloid_mofa <- prepare_mofa(
  object = myeloid_mofa,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts,
  mefisto_options = mefisto_opts
) 
```

## Train

```{r}
outfile <- "/nfs/team205/ed6/data/Fetal_immune/myeloid_mefisto_model.hdf5"
myeloid_mofa_trained <- run_mofa(myeloid_mofa, outfile = outfile)
```

## Load trained model
```{r}
myeloid_mofa_trained <- load_model(outfile, load_interpol_Z = TRUE)
```

